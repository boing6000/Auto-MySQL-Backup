#!/bin/sh
# auto mysql backup
# rafalkasprzyk.com
#######################################################################
# file variables
DATE=$(date +"%d-%m-%Y")
FILENAME="backup_$DATE.sql"
BACKUPDIR='/tmp/mysql'
BACKUPFILE="$BACKUPDIR/$FILENAME.tar.gz"
MAILTO='admin@example.com'
# FTP
FTPHOST='1.1.1.1'
FTPPORT='21'
FTPUSER='backup'
FTPPASS=''
REMOTEDIR="/backupyohoit"
# MYSQL
SQLHOST='localhost'
SQLUSER='backup'
SQLPASS=''
#
GZIP="$(which gzip)"
# mail
MAILSUB="MySQL Backup $(hostname) report"
#######################################################################
# Only change if your UNIX stores bin in diffrent location
NCFTP='/usr/bin/ncftpput'
MYSQL='/usr/bin/mysql'
MYSQLDUMP='/usr/bin/mysqldump'
TAR="$(which tar)"
MAILC='/bin/mail'
MFILE='/tmp/ftpout.$$.txt'
MESS=''
#######################################################################

if [ ! -x $NCFTP ]; then
  echo "$NCFTP command not found, contact $MAILTO"
  exit 1
fi

if [ ! -x $MYSQL ]; then
  echo "$MYSQL command not found, contact $MAILTO"
  exit 1
fi

if [ ! -x $MYSQLDUMP ]; then
  echo "$MYSQLDUMP command not found, contact $MAILTO"
  exit 1
fi

if [ ! -x $MAILC ]; then
  echo "$MAILC command not found, contact $MAILTO"
  exit 1
fi

if [ ! -x $TAR ]; then
  echo "$TAR command not found, contact $MAILTO"
  exit 1
fi

echo "* Make MYSQL dump file"

[ ! -d $BACKUPDIR ] && mkdir -p $BACKUPDIR || /bin/rm -f $BACKUPDIR/*

DBS="$($MYSQL -h $SQLHOST --user="$SQLUSER" --password="$SQLPASS" -Bse 'show databases')"

for db in $DBS
do
    FILE=$BACKUPDIR/$db.$FILENAME-$DATE-$(date +"%T").gz
    $MYSQLDUMP -h $SQLHOST --user="$SQLUSER" --password="$SQLPASS" $db | $GZIP -9 > $FILE
    echo "- creating $db dump file"
done

$TAR cvzf $BACKUPFILE $BACKUPDIR/*

if [ $? -ne 0 ];
then
	echo "** MYSQL file cound not be created"
	MESS="$MYSQL failed to create backup. Nothing uploaded to remote FTP server ($FTPHOST)"
else
	echo "** MYSQL file created"
	echo "** Connect to FTP and upload a file "

	$NCFTP -u $FTPUSER -p $FTPPASS -P $FTPPORT $FTPHOST $REMOTEDIR $BACKUPFILE

	OSTAT="$?"
	case $OSTAT in
		0) MESS="Success.";;
		1) MESS="Could not connect to remote host $FTPHOST on port $FTPPORT.";;
		2) MESS="Could not connect to remote host $FTPHOST on port $FTPPORT - timed out.";;
		3) MESS="Transfer failed.";;
		4) MESS="Transfer failed - timed out.";;
		5) MESS="Directory change failed.";;
		6) MESS="Directory change failed - timed out.";;
		7) MESS="Malformed URL.";;
		8) MESS="Usage error. May be your version of ncftpput ($NCFTP) is old";;
		9) MESS="Error in login configuration file.";;
		10)MESS="Library initialization failed.";;
		11)MESS="Session initialization failed.";;
		*) MESS="Unknown error, contact admin $MAILTO";;
	esac
fi

echo "** Sending backup info to: $MAILTO"

BACKUP_SIZE=$(ls -lah $BACKUPFILE | awk '{ print $5}')

>$MFILE
echo "Backup status for $(hostname) as on $(date) :" >>$MFILE
echo "" >>$MFILE
echo "Backup file : $FILENAME" >>$MFILE
echo "Backup file size : $BACKUP_SIZE" >>$MFILE
echo "Backup ftp server : $FTPHOST" >>$MFILE
echo "Backup status message : $MESS" >>$MFILE
echo "" >>$MFILE
echo "-- Automatically generated by $(basename $0)" >>$MFILE

# send an email to admin
$MAILC -s "$MAILSUB" $MAILTO <$MFILE

[ -f $MFILE ] && rm -f $MFILE || :
[ -f $FILENAME ] && rm -f $FILENAME || :

echo "*** Done"
